{% extends 'base.html' %} {% block content %}
<div class="row sticky">
    <a href="{{url_for('index')}}" class="back-button"><i class="fas fa-chevron-left"></i></a>
</div>
<div class="container">
    <h1>Add A New Recipe</h1>

    <form name="new_recipe_form" action="{{url_for('insert_recipe')}}" method="POST" class="needs-validation" novalidate>
        <div class="row">
            <div class="col-md-6">
                <label class="label-margin" for="recipe_name">Recipe Name</label>
                <input type="text-area" class="form-control capitalise " name="recipe_name" id="recipe_name" placeholder="Enter recipe name " autofocus required>
                <div class="invalid-feedback">
                    Please enter a recipe name (max 25 characters).
                </div>
                <div class="valid-feedback">
                    Sounds good!
                </div>
            </div>
            <div class="col-md-6">
                <label for="cook_name">Cook Name</label>
                <input type="text-area" class="form-control capitalise" name="cook_name" id="cook_name" placeholder="{{session['username']}}" disabled>
            </div>
        </div>

        <div class="row form-group ">
            <div class="col-md-4 ">
                <label class="label-margin" for="cuisine_name">Cuisine Type  <span class="text-muted">(Select from dropdown)</span></label>
                <select class="form-control" name="cuisine_name" id="cuisine_name" required>
                    <option value = " " disabled selected></option>
                    {% for cuisine in cuisines %}
                    <option value="{{ cuisine.cuisine_name }}">{{ cuisine.cuisine_name.title() }}</option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">
                    Please select a type of cuisine.
                </div>
                <div class="valid-feedback">
                    Looks good!
                </div>
            </div>

            <div class="col-md-4">
                <label class="label-margin" for="meal_type">Meal Course  <span class="text-muted">(Select from dropdown)</span></label>
                <select class="form-control" name="meal_course" id="meal_course" required>
                    <option value = " " disabled selected></option>
                    {% for meal in meal_course%}
                    <option value="{{ meal.course_name }}">{{ meal.course_name.title() }}</option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">
                    Please select a meal type.
                </div>
                <div class="valid-feedback">
                    Looks good!
                </div>

            </div>

            <div class="col-md-4">
                <label for="main_ingredient">Main Ingredient  <span class="text-muted">(Select from dropdown)</span></label>
                <select class="form-control" name="main_ingredient" id="main_ingredient" required>
                    <option value = " " disabled selected></option>
                    {% for main in main_ingredient%}
                    <option value="{{ main.main_ingredient }}">{{ main.main_ingredient.title() }}</option>
                    {% endfor %}
                    </select>
                <div class="invalid-feedback">
                    Please choose a main ingredient.
                </div>
                <div class="valid-feedback">

                </div>
            </div>
        </div>


        <div class="row">
            <div class="no-gutter col-sm-6 col-md-3 col-lg-2">
                <label for="prep_time ">Prep Time:</label>
                <input type="number" class="form-control" name="prep_time" id="prep_time" placeholder="minutes" required>
            </div>
            <div class="invalid-feedback">
                Please enter numbers only
            </div>
            <div class="valid-feedback">
                Looks good!
            </div>

            <div class="no-gutter col-sm-6 col-md-3 col-lg-2">
                <label for="cook_name">Total Cook Time:</label>
                <input type="number" class="form-control" name="total_cooking_time" id="total_cooking_time" placeholder="minutes" required>
            </div>


            <div class="no-gutter col-sm-6 col-md-3 col-lg-2">
                <label for="servings">Serves</label>
                <input type="number" class="form-control" name="servings" id="servings" placeholder="servings" required>
            </div>
        </div>


        <h3>Add Your Ingredients</h3>
        <div class="row" class="no-gutters">
            <div class="col-md-12">
                <div class="input-group">
                    <textarea class="form-control" id="ingredients" name="ingredients" rows="5 " placeholder="Enter each ingredient on a new line. " required></textarea>
                </div>
            </div>
        </div>


        <h3>Cooking Method</h3>
        <div class="row">
            <div class="col-md-12">
                <div class="input-group">
                    <textarea class="form-control" id="instructions" name="instructions" rows="5" placeholder="Enter each step on a new line." required></textarea>
                </div>
            </div>
        </div>



        <h3>Nutritional Information</h3>
        <div class="row">
            <div class="col">
                <p>All values should be entered per serving</p>
            </div>
        </div>

        <div class="row">
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <label for="protein">Protein</label>
                <input type="number" class="form-control" name="protein" id="protein" placeholder="grams">
            </div>

            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <label for="fat_per_serve">Fat</label>
                <input type="number" class="form-control" name="fat_per_serve" id="fat_per_serve" placeholder="grams">
            </div>

            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <label for="carbohydrate">Carbohydrate</label>
                <input type="number" class="form-control" name="carbohydrate" id="carbohydrate" placeholder="grams">
            </div>

            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <label for="dietary_fibre">Dietary Fibre</label>
                <input type="number" class="form-control" name="dietary_fibre" id="dietary_fibre" placeholder="grams">
            </div>

            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <label for="cholesterol">Cholesterol</label>
                <input type="number" class="form-control" name="cholesterol" id="cholesterol" placeholder="milligrams">
            </div>

            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <label for="energy">Energy</label>
                <input type="number" class="form-control" name="energy" id="energy" placeholder="kJ">
            </div>
        </div>

        <div class="container-fluid no-gutters no-padding">
            <h3>Recipe Image</h3>
        </div>

        <div><input type="file" id="file_input" />
            <p id="status">Please select a file</p>
            <img id="preview" src="/static/default.png" />
        </div>
        <div class="row">
            <div class="col">
                <button class="btn btn-success" type="submit" id="add_recipe">Add Recipe</button> <br>Click here to add your recipe
            </div>
        </div>

    </form>
    </form>



</div>
<script>
    (function() {
        document.getElementById("file_input").onchange = function() {
            var files = document.getElementById("file_input").files;
            var file = files[0];
            if (!file) {
                return alert("No file selected.");
            }
            getSignedRequest(file);
        };
    })();

    function getSignedRequest(file) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/sign_s3?file_name=" + file.name + "&file_type=" + file.type);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    uploadFile(file, response.data, response.url);
                } else {
                    alert("Could not get signed URL.");
                }
            }
        };
        xhr.send();
    }

    function uploadFile(file, s3Data, url) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", s3Data.url);

        var postData = new FormData();
        for (key in s3Data.fields) {
            postData.append(key, s3Data.fields[key]);
        }
        postData.append('file', file);

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200 || xhr.status === 204) {
                    document.getElementById("preview").src = url;
                    document.getElementById("avatar-url").value = url;
                } else {
                    alert("Could not upload file.");
                }
            }
        };
        xhr.send(postData);
    }
</script>

{% endblock %}